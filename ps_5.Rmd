---
title: "Problem Set 5"
author: "Westley Cook"
date: "3/9/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(haven)
library(formattable)
library(magrittr)
library(gt)
library(infer)

```

## Mad Libs

```{r mad_lib_1, echo=FALSE}

voters <- read_dta("raw-data/ns20191226/ns20191226.dta")

mad_1 <- voters %>% 
  select(gun_registry) %>% 
  filter(gun_registry != 888) %>% 
  count() %>% 
  pull(n) %>% 
  format(big.mark = ",")

```

**ML 1)** Not all respondents were asked every question. **`r mad_1`** respondents were asked the question about whether the USA should create a gun registry.

```{r mad_lib_2, echo=FALSE}

mad_2 <- voters %>% 
  select(ban_guns,
         gun_registry,
         guns_bg,
         limit_magazines,
         statements_gun_rights,
         household_gun_owner) %>% 
  filter(gun_registry != 888,
         statements_gun_rights != 888) %>% 
  mutate(gun_owner = ifelse(household_gun_owner == 1,
                            TRUE,
                            FALSE)) %>% 
  summarize(mean(gun_owner)) %>% 
  percent(digits = 2)

```

**ML 2)** Of the respondents that got asked all four gun policy questions, **`r mad_2`** are gun owners. (For the purposes of this question, you can assume that the people who answered “not sure” are not gun owners). Round to 2 digits after the decimal point.

```{r mad_lib_3, echo=FALSE}

no_guns <- voters %>% 
  select(statements_gun_rights,
         household_gun_owner) %>% 
  filter(household_gun_owner == 3,
         statements_gun_rights == 1:4) %>% 
  summarize(mean(statements_gun_rights)) %>% 
  round(digits = 2)

have_guns <- voters %>% 
  select(statements_gun_rights,
         household_gun_owner) %>% 
  filter(household_gun_owner == 1:2, # |
#           household_gun_owner == 999,       should I include this? No, right?
         statements_gun_rights == 1:4) %>% 
  summarize(mean(statements_gun_rights)) %>% 
  round(digits = 2)

```

**ML 3)** The average “agreement” score (from 1-4) on the statement_gun_rights variable is **`r no_guns`** for those respondents who live in households without guns, while the average “agreement” score in households with guns is **`r have_guns`**. (Calculate the average dropping respondents who weren’t asked, didn’t know, or skipped either question, and round to two digits after the decimal point).

```{r mad_lib_4, echo=FALSE}

voters %>% 
  filter(age >= 18,
         age < 30) %>% 
  select(religion) %>% 
  as_factor() %>% 
  table() %>% 
  as.data.frame()

# AARRGGGHHHH

```

**ML 4)** Another set of questions asks about religion. The first ranked category of religion for the age group of people 18-30 (don’t include 30) is **“X”** . The first-ranked religion category for people 30 and older is **“X”**. Hint: you’re going to need the “labels” that are imported from the dta using haven; we suggest using as_factor to assign the right labels to the religion variable.

```{r mad_lib_5, echo=FALSE}

voters %>% 
  filter(age >= 18,
         age < 30) %>% 
  select(religion) %>% 
  as_factor() %>% 
  table() %>% 
  as.data.frame()

# give up...

```

**ML 5)** Lots of people say that the younger generation has the highest percent of “nones;” people who answer “nothing in particular”, when you ask them their religion. In the 18-30 age group, “nothing in particular” is ranked **X**, while in the 30 and above group, “nothing in particular” is ranked **X**.

```{r mad_lib_6, echo=FALSE}

voters %>% 
  filter(religion == 12,
         statements_gun_rights != 888) %>% 
  select(statements_gun_rights) %>% 
  as_factor() %>% 
  table()

# how do I pull out the label???

```

**ML 6)** Consider again the nones (all people who responded “nothing in particular”) when asked about their religion. In this group, the most popular position is to **X** (strongly disagree, disagree, agree, or strongly agree?) that it is more important for the government to control who owns guns than it is for the government to protect the right to own guns (use the variable “statement_gun_rights” and only include respondents who were asked both of these questions).

## Question 2: Simulations with List Columns

### 2a)

```{r question_2a, echo=FALSE}

draw_cards <- function(n) {
  cards <- c("diamonds", "hearts", "spades", "clubs")
  sample(cards, n, replace = TRUE)
}

```

I wrote a function to sample the suit of n cards.

### 2b)

```{r question_2b, echo=FALSE}

two_cards_ten_times <- tibble(draws = map(rep(2, 10), draw_cards))

```

I made a tibble that shows the result of drawing 2 cards 10 times, using map().

### 2c)

```{r question_2c, echo=FALSE}

two_cards_ten_times %<>%
  mutate(
    first_red = map_lgl(draws,
                        ~ ifelse(.[[1]][1] == "hearts" |
                                   .[[1]][1] == "diamonds",
                                 TRUE,
                                 FALSE)))

two_cards_ten_times %<>%
  mutate(
    second_red = map_lgl(draws,
                        ~ ifelse(.[[2]][1] == "hearts" |
                                   .[[2]][1] == "diamonds",
                                 TRUE,
                                 FALSE)))

```

I added two columns (one for each card drawn) which say whether the card was red (hearts or diamonds) or not.

### 2d)

I added a third new column, showing the color outcome of each draw, and produced the following table:

```{r question_2d, echo=FALSE}

two_cards_ten_times %<>%
  mutate(outcome = case_when(
    first_red == TRUE & second_red == TRUE ~ "Both red",
    first_red == FALSE & second_red == FALSE ~ "Both black",
    TRUE ~ "Mixed"
  ))

two_cards_ten_times %>% 
  gt() %>%
  tab_header(title = "Drawing Two Cards",
             subtitle = "Card Colors") %>% 
  cols_label(draws = "Draw",
             first_red = "First card red?",
             second_red = "Second card red?",
             outcome = "Color Outcome")

```

### 2e)

```{r question_2e, echo=FALSE}

simulation_1000 <- tibble(draws = map(rep(2, 1000), draw_cards)) %>% 
  mutate(
    first_red = map_lgl(draws,
                        ~ ifelse(.[[1]][1] == "hearts" |
                                   .[[1]][1] == "diamonds",
                                 TRUE,
                                 FALSE)))

simulation_1000 %<>%
  mutate(
    second_red = map_lgl(draws,
                        ~ ifelse(.[[2]][1] == "hearts" |
                                   .[[2]][1] == "diamonds",
                                 TRUE,
                                 FALSE)))
  
simulation_1000 %<>%
  mutate(outcome = case_when(
    first_red == TRUE & second_red == TRUE ~ "Both red",
    first_red == FALSE & second_red == FALSE ~ "Both black",
    TRUE ~ "Mixed")
  )
  
percent_mixed <- simulation_1000 %>% 
  mutate(mixed = ifelse(outcome == "Mixed",
                        TRUE,
                        FALSE)) %>% 
  summarize(mean(mixed)) %>% 
  percent(digits = 2)

```

A simulation of drawing two cards 1000 times resulted in **`r percent_mixed`** of draws having "mixed" colors.

## Question 3: Modeling a Study Population

```{r question_3, echo=FALSE}

pop <- tibble(id = 1:6120,
              grade = c(rep("freshman", 1800),
                        rep("junior", 1570),
                        rep("senior", 1300),
                        rep("sophomore", 1450)))

pop1 <- pop %>% 
  group_by(grade) %>% 
  count() %>% 
  mutate(pct = n / nrow(pop))
  
ggplot(pop1, aes(grade, pct)) +
  geom_col()  +
  theme_classic() +
  labs(title = "University Composition by Grade",
       subtitle = "Entire Study Population") +
  scale_y_continuous(labels = scales::percent)

# need to add text labels showing value in each column

```


We’re going to start by generating our own study population, a “university” full of 1800 freshmen, 1450 sophomores, 1570 juniors, and 1300 seniors. Using rep, create a tibble with 6120 rows, where each row represents a student. Your tibble should have an ID column (1:6120) a “grade” column for each student.

Make a simple bar chart showing the population of your university. Make sure that your graph, like ours, shows the proportion of each group in the population.

## Question 4: Sampling

```{r question_4, echo=FALSE}

samples <- set.seed(02139) %>% 
  rep_sample_n(tbl = pop, size = 25, replace = FALSE, reps = 5000) %>% 
  group_by(replicate, grade) %>%
  count() %>% 
  mutate(n_freshmen = ifelse(grade == "freshman",
                             n,
                             NA)) %>% 
  group_by(replicate) %>% 
  mutate(pct_freshmen = n_freshmen / 25)
  

samples %>% 
  subset(!is.na(pct_freshmen)) %>% 
  ggplot(aes(pct_freshmen)) +
  geom_bar() +
  theme_classic() +
  scale_x_continuous(labels = scales::percent,
                     breaks = c(0, .1, .2, .3, .4, .5, .6)) +
  labs(title = "Sampling Distribution of Percent Freshmen",
       subtitle = "From 5,000 Samples of 25 Students") +
  ylab("Count") +
  xlab("Percent Freshmen")

# Add count to bars??

```

Usually in the real world, our populations are too big or difficult to measure, so we take a sample to try and gauge the relative proportion of each group. Using rep_sample_n from the infer package, draw 5000 samples of 25 students each from the population from question 3. Use set.seed(02139) so that your randomly drawn distributions have the same values as ours. Save the percent freshmen in each sample. Plot the distribution of percent freshmen in a nice plot.

## Question 5: 

```{r question_5, echo=FALSE}

sizes <- list(25, 50, 100, 500)
sizes <- set_names(sizes, names = sizes)

# sizes_p <- list(2, 3, 4, 5)
# sizes_p <- set_names(sizes_p, names = sizes_p)
# 
# map_sample_practice <- function(size){
#   set.seed(02139) %>% 
#   rep_sample_n(tbl = pop, size = size, replace = FALSE, reps = 10) %>% 
#     mutate(size = size)
# }
# 
# sample_dist_practice <- map_df(sizes_p, map_sample_practice)

# sample_dist_practice %>% 
#   group_by(replicate) %>% 
#   summarize(n_freshmen = sum(grade == "freshman"))

map_sample <- function(size){
  set.seed(02139) %>% 
    rep_sample_n(tbl = pop, size = size, replace = FALSE, reps = 5000) %>% 
    mutate(size = size)
}

sample_dist <- map_df(sizes, map_sample)

grouped_sample_dist <- sample_dist %>%
  group_by(replicate, size) %>% 
  summarize(n_freshmen = sum(grade == "freshman")) 

with_prop_freshmen <- grouped_sample_dist %>% 
  mutate(pct_freshmen = n_freshmen / size)

with_prop_freshmen %>%
  ggplot(aes(x = pct_freshmen,
             fill = as.factor(size))) +
  geom_density(alpha = 0.2) +
  theme_classic() +
  labs(title = "Distribution of Percentage Freshmen",
       subtitle = "Average sampled percentage gets closer to true percentage as sample size increases") +
  ylab("Count") +
  xlab("Proportion of freshmen") +
  scale_fill_discrete(name = "Sample Size")


```

First, create a list of four different sizes (25,50,100,500). Use sizes <- set_names(sizes, names = sizes), to make sizes a “named” list, which will help R cycle through your code.

Reset the seed to 02139. Use map_df to call rep_sample_n to sample from your university tibble, using size as an input. Your output should be a tibble with 3,375,000 rows and four columns; one for the draw number (1:5000), one for the size (25,50,100, or 500), the student’s ID, and their grade. If you’re stuck on how to cycle through the elements of the “sizes” list, try using size =. in your map_df() expression, and then telling R what the .id stands for outside the parentheses. You don’t need to print this tibble

Use a summarize function to count the number of freshmen in each sample, and then take the proportion. Your tibble should now have 20,000 rows; one for each draw.



Using geom_density, plot the distribution of the proportion of freshmen by sample size. Your plot should look roughly like this:
